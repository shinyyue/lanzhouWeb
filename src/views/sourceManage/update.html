<div id="source-manage-details">
    <div class="course-title">
        <div class="course-title-location">
            <span>您的位置：</span>
            <span>资源管理 > 我的资源库 > 修改资源</span>
        </div>
    </div>


    <div class="layui-row">
        <div class="layui-col-md6 layui-form-item">
            <label class="layui-form-label require">资源名称</label>
            <input
                class="common-form-input layui-col-md10"
                type="text"
                name="resourceName"
                id="resourceName"
                placeholder="请输入资源名称"
                style="width: 60%;"
            />
        </div>
        <!-- <div class="layui-col-md6 layui-form-item">
            <label class="layui-form-label ">所属课程</label>
            <span id="courseName"></span>
        </div> -->
        <form action="" class="layui-form mylist-add-form">
            <div class="layui-col-md12 layui-form-item">
                <label class="layui-form-label require">所属课程</label>
                <select name="curriculumId" id="curriculumId" lay-verify="">
                    <option value="">请选择所属课程</option>
                </select>
            </div>
        </form>
    </div>

    <div class="layui-row">
        <div class="layui-col-md6 layui-form-item">
            <label class="layui-form-label ">负责教师</label>
            <span id="teacherName"></span>
        </div>
        <div class="layui-col-md6 layui-form-item">
            <label class="layui-form-label ">使用权限</label>
            <span id="accessAuthority"></span>
        </div>
    </div>


    <div class="layui-row">
        <div class="layui-col-md12 layui-form-item">
            <label class="layui-form-label">资源描述</label>
            <div class="layui-col-md9">
                <textarea name="desc"
                          class="layui-textarea"
                          id="resourceDes"></textarea>
            </div>
        </div>
    </div>

    <div class="layui-row">
        <div class="layui-col-md6 layui-form-item">
            <label class="layui-form-label ">点击量</label>
            <span id="clickNum"></span>
        </div>
        <div class="layui-col-md6 layui-form-item">
            <label class="layui-form-label ">下载量</label>
            <span id="downloadNum"></span>
        </div>
    </div>
    <!-- <div class="layui-row">
        <div class="layui-col-md12 layui-form-item">
            <label class="layui-form-label">资源评分</label>
            <span>没有字段</span>
        </div>
    </div> -->

    <div class="layui-row">
        <div class="layui-col-md12 layui-form-item">
            <label class="layui-form-label "></label>
            <div>
                <div class="layui-btn primary-btn"
                id="sourmanage_update">
                修改
               </div>
                <div class="layui-btn layui-btn-primary cancel-btn"
                     id="sourmanage_add_cancle">
                    返回
                </div>
            </div>
        </div>
    </div>

    <div class="source-details-inner">
        <div class="source-display unScorm-inner">
            <div id="fileUrl"
                 style="width: 100%; height: 780px;"></div>
            <div class="webgl-content"
                 id="u3dFileUrl"
                 style="width: 100%; height: 780px;display: none;"></div>
        </div>
        <div style="display: none; color: red;"
             id="showTip">
            <div>推荐使用360浏览器兼容模式或者IE9以上</div>
            <a href="http://47.105.130.130:8100/dataBank/exportCult3D"
               style="color: red;text-decoration: underline;">若加载失败，点击安装Cult3D插件</a>
        </div>
        <div class="source-display"
             id="scorm_fileUrl"
             style="display: none">
            <div id="mune_area">
                <div class="tab_a"
                     id="tab_b">
                    <ul class="tab_con tabcon_sy">
                        <li id="tabcon1">
                            <div class="munebtnlist"
                                 id="tabcon1_menulist"></div>
                        </li>
                        <li id="tabcon2"
                            class="hidden">
                            <div class="munebtnlist">
                                <div id="tabcon2_menulist"></div>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
            <div id="mune_btn"
                 class="munebtna"
                 data-zt="a"></div>
            <div id="pagecon"
                 style="height: 780px;float: left">
                <iframe frameBorder="0"
                        id="innerTarget"
                        name="innerTarget"
                        src="./iframe2.htm"
                        style="width: 100%; height: 100%"></iframe>
            </div>
        </div>
    </div>
</div>
<script src="src/plugins/UnityLoader.js"></script>
<script src="src/plugins/UnityProgress.js"></script>
<script src="src/plugins/menuTree.js"></script>
<script>
    layui.use(['form', 'admin'], function () {
        var $ = layui.jquery,
            admin = layui.admin,
            conf = layui.conf,
            route = layui.router(),
            id = route.search.id,
            form = layui.form,
            details = {};

        form.render()
        getAllCourses(function() {
            getDetails()            
        })

        $('#sourmanage_update').on('click', function() {
            updateData()
        })

        $('#collect').on('click', function () {
            collect()
        })
        $('#canclecollect').on('click', function () {
            cancleCollect()
        })
        $('#download').on('click', function () {
            download()
        })
        $('#sourmanage_add_cancle').on('click', function () {
            admin.navigate('/sourceManage/myList')
            // window.history.go(-1)
        })

        function getAllCourses(callback) {
            admin.post({
                url: '/vsMpCurriculum/getList',
                data: JSON.stringify({
                    page: 1,
                    rows: 10000
                }),
                success: function(res) {
                    $('#curriculumId').html('<option value="">请选择</option>')
                    if (res.data && res.data.items) {
                        for (var i = 0; i < res.data.items.length; i++) {
                            var item = res.data.items[i];
                            $('#curriculumId').append(
                                '<option value="' +
                                res.data.items[i].id +
                                    '" name="curriculumId">' +
                                res.data.items[i].curriculumName +
                                    '</option>'
                            )
                            form.render()
                        }
                    }
                    callback && typeof callback === 'function' && callback(res)
                }
            })
        }

        function updateData() {
            var data = {
                id: id,
                name: $('#resourceName').val() && $('#resourceName').val().trim(),
                curriculumId: Number($('#curriculumId').val()) || ''
            }
            admin.post({
                url: '/dataBank/updateResource',
                data: JSON.stringify(data),
                success: function(res) {
                    if (res.code == 200) {
                        layer.msg('修改成功')
                        admin.navigate('/sourceManage/myList')
                    } else {
                        layer.msg(res.msg || '修改失败')
                    }
                }
            })
        }

        function getDetails() {
            admin.get({
                url: '/dataBank/queryOne?id=' + id,
                success: function (res) {
                    var data = res.data
                    details = data
                    if (!res.data) return
                    $('#resourceName').val(data.resourceName)
                    $('#teacherName').html(data.teacherName)
                    $('#accessAuthority').html(data.accessAuthority)
                    $('#clickNum').html(data.clickNum)
                    $('#downloadNum').html(data.downloadNum)
                    $('#curriculumId').val(data.curriculumId)
                    $('#resourceDes').val(data.resourceDes)
                    form.render()
                    if (data.canDownload == 0 || data.type != 5) {
                        //$('#download').attr('style', 'display:none;')
                        // $('#download').hide()
                    }
                    fileUrl = conf.fileRequestUrl + '/' + data.fileUrl
                    if (data.type != 7) {
                        $('.unScorm-inner').show()
                    } else {
                        $('#showTip').show()
                    }
                    if (data.type == 1) {
                        // 文档
                        $('#fileUrl').html(
                            '<iframe src="' + 
                            fileUrl +
                            '" width="100%" height="780px;" frameborder="1"></iframe>'
                        )
                    } else if (data.type == 2) {
                        // 图片
                        $('#fileUrl').html(
                            '<img src="' +
                            fileUrl +
                            '" style="width: 100%;">'
                        )
                    } else if (data.type == 3) {
                        // 视频
                        if((/(.mp4)/ig).test(fileUrl)) {
                            $('#fileUrl').html(
                                '<video src="' +
                                fileUrl +
                                '" controls="controls" style="width: 100%; height: 100%;">'
                            )
                        } else if((/.flv/ig).test(fileUrl)) {
                           $('#fileUrl').html(
                                '<object  classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,29,0" style="width: 100%; height: 100%;">'+
                                    '<param name="movie" value="' + conf.webUrl + '"flvplayer.swf"/>'+
                                    '<param name="quality" value="high" />'+
                                    '<param name="allowFullScreen" value="true" />'+
                                '   <embed  src="' + conf.webUrl + '"flvplayer.swf" flashvars="vcastr_file=' + fileUrl + '&IsAutoPlay=1" type="application/x-shockwave-flash" style="width: 100%; height: 100%;">'+
                                '   </embed>'+
                                '</object>'
                            )
                        }
                    } else if (data.type == 4) {
                        var width = $('.source-details-inner').width()
                        $('#fileUrl').html(
                            '<object class="flash_object"  width="' + width +'" height="' + $('#fileUrl').height() +'">'+
                            '<param name="src" value="'+ fileUrl +'" />'+
                            '<param name="quality" value="high" />'+
                            '<param value="transparent">'+
                            '<embed wmode="transparent" class="flash_object" src="' +
                            fileUrl +
                            '" type="application/x-shockwave-flash" width="' + width +'" height="' +
                            $('#fileUrl').height() +'" quality="high" /><object>'
                        )
                    } else if (data.type == 5) {
                        // exe
                        $('.unScorm-inner').hide();
                    } else if (data.type == 6) {
                        // U3D
                        $('#fileUrl').hide()
                        $('#u3dFileUrl').show()
                        var jsonFile = JSON.parse(data.fileUrl).json;
                        UnityLoader.instantiate(
                            'u3dFileUrl',
                            conf.fileRequestUrl + '/' + jsonFile, {
                                onProgress: UnityProgress
                            }
                        )
                    } else if (data.type == 7) {
                        $('#scorm_fileUrl').show()
                        // scorm课件
                        var sourceList = JSON.parse(data.fileUrl)
                        var munebtn = document.getElementById('mune_btn')
                        var mune = document.getElementById('mune_area')
                        var treeStr = ''

                        for (var i = 0; i < sourceList.length; i++) {
                            var floor = ''
                            var id = ''
                            id = sourceList[i].id
                            var list = sourceList[i].resourceName.split('.');
                            var type = list[list.length - 1]
                            for (
                                var k = 0; k < Number(sourceList[i].floor); k++
                            ) {
                                floor += '-'
                            }
                            
                            if (!type || (type !== 'html' && type !== 'htm')) {
                                addtree(
                                    floor + sourceList[i].name
                                )
                            } else {
                                addtree(
                                    floor + sourceList[i].name,
                                    conf.fileRequestUrl + '/' +
                                    sourceList[i].resourceName,
                                    'innerTarget',id
                                )
                            }
                            
                        }
                        createtree('tabcon1_menulist')

                        $('.menu-list').click(function (index) {
                            var list = '',
                                type = ''
                            for (var i = 0; i < sourceList.length; i++) {
                                if (sourceList[i].id == index.target.dataset.id ) {
                                    list = sourceList[i].sourceName.split('.')
                                    type = list[list.length - 1]
                                    break
                                }
                            }
                        })

                        var minWidth = ($('#scorm_fileUrl')[0].offsetWidth - $('#mune_area')[0].offsetWidth -
                        $('#mune_btn')[0].offsetWidth) + 'px'
                        var maxWidth = ($('#scorm_fileUrl')[0].offsetWidth - $('#mune_btn')[0].offsetWidth) + 'px'

                        $('#pagecon').width(minWidth)

                        munebtn.onclick = function () {
                            var p = $('#pagecon')
                            if (this.getAttribute('data-zt') == 'a') {
                                mune.style.display = 'none'
                                this.className = 'munebtnb'
                                this.setAttribute('data-zt', 'b')
                                p.css({
                                    'min-width': maxWidth
                                })
                            } else {
                                mune.style.display = 'block'
                                this.className = 'munebtna'
                                this.setAttribute('data-zt', 'a')
                                p.css({
                                    'min-width': minWidth
                                })
                            }
                        }
                    }
                }
            })
        }

        function collect() {
            var data = {
                id: Number(id)
            }
            admin.put({
                url: '/resCollect/add?id=' + id,
                // data: JSON.stringify(data),
                success: function (res) {
                    layer.msg('收藏成功')
                    getDetails()
                }
            })
        }

        function cancleCollect() {
            admin.delete({
                url: '/resCollect/del?id=' + id,
                success: function (res) {
                    layer.msg('取消收藏成功')
                    getDetails()
                }
            })
        }

        function download() {
            window.open(
                conf.requestUrl +
                '/dataBank/downloadFile?id=' +
                id +
                '&filePath=' +
                details.fileUrl
            )
        }
    })

</script>
<style>
    #source-manage-details #fileUrl {}

    .source-details-inner {
        padding: 20px 0;
    }

    body {
        scrollbar-3dlight-color: transparent;
        scrollbar-track-color: transparent;
        scrollbar-base-color: transparent;
    }

    .source-display {
        width: 100%;
        height: 780px;
        overflow: auto;
        background: rgba(0, 0, 0, 0.2);
        position: relative;
    }

    .source-display.unScorm-inner{
        display: none;
    }
    #pagecon {
        overflow: hidden;
    }

    #pagecon::-webkit-scrollbar {
        width: 0;
    }

    #source-manage-details .layui-form-item span {
        display: inline-block;
        padding: 9px 0px;
        font-size: 16px;
    }

    .layui-textarea {
        width: 100%;
    }

    #mune_area {
        width: 326px;
        height: 780px;
        float: left;
        overflow-x: hidden;
        overfloe-y: auto;
    }

    #mune_btn {
        width: 16px;
        height: 780px;
        float: left;
    }

    .munebtna {
        background: url(pic/left.png) center center #4a5279 no-repeat;
        cursor: pointer;
    }

    .munebtnb {
        background: url(pic/right.png) center center #4a5279 no-repeat;
        cursor: pointer;
    }

    .hidden {
        display: none;
    }

    .tab1ys {
        width: 326px;
        height: 60px;
        border-bottom: #0d0f14 solid 5px;
    }

    .tab1ys li {
        width: 163px;
        float: left;
    }

    .tab1ys li a {
        width: 73px;
        height: 60px;
        background: #4b4b4b;
        display: block;
        position: relative;
        /* font: normal 30px/60px "΢���ź�"; */
        color: #fff;
        padding-left: 90px;
    }

    .tab1ys li a img {
        position: absolute;
        top: 7px;
        left: 40px;
        border: none;
    }

    .tab1ys li a.active {
        background: #f95900;
    }

    .munebtnlist {
        width: 280px;
        margin: 0px 0 0 0px;
    }

    .munebtnlist h4 {
        /* font: bold 14px/16px '΢���ź�'; */
        height: 16px;
        padding-left: 20px;
        background: url(pic/1_open.png) no-repeat;
    }

    #tabcon1 {
        padding: 20px 10px;
    }

</style>
<style type="text/css">
    /* @import 'TemplateDate/style.css'; */

    .blockhide {
        display: block;
    }

    .blockmove {
        overflow: hidden;
        height: 1px;
        display: block;
    }

    .blockshow {
        overflow: visible;
        display: none;
    }

    .hideme {
        overflow: visible;
        display: none;
    }

    .showme {
        overflow: visible;
        display: block;
    }

    .faisunMenu td {
        font-size: 10pt;
    }

</style>
