<div id="examine-addknow" lay-title="添加知识点">
    <div class="course-title">
        <div class="course-title-location">
            <span>您的位置：</span>
            <span>题库管理 > 知识点 > 添加知识点</span>
        </div>
    </div>
    <form action="" class="layui-form my-add-form">
        <div class="layui-row">
            <div class="layui-col-md6 layui-form-item">
                <label class="layui-form-label">所属课程名称</label>
                <select name="curriculumId" id="curriculumId" lay-verify="">
                    <option value="">选择课程</option>
                </select>
            </div>
        </div>
        <div class="layui-row">
            <div class="layui-col-md6 layui-form-item">
                <label class="layui-form-label">父知识点</label>
                <select name="pName" id="pName" lay-verify="">
                    <option value="0">根知识点</option>
                </select>
            </div>
        </div>
        <div class="layui-row">
            <div class="layui-col-md6 layui-form-item">
                <label class="layui-form-label">知识点名称</label>
                <input
                    class="common-form-input"
                    type="text"
                    name="name"
                    id="name"
                    placeholder="请输入知识点名称"
                />
            </div>
        </div>
        <div class="layui-row">
            <div class="layui-col-md12 layui-form-item">
                <label class="layui-form-label">知识点描述</label>
                <div class="layui-col-md9">
                    <textarea
                        name="describe"
                        placeholder="请输入内容"
                        class="layui-textarea"
                    ></textarea>
                </div>
            </div>
        </div>
        <div class="layui-row">
            <div class="layui-col-md6 layui-form-item">
                <label class="layui-form-label"></label>
                <div>
                    <button
                        class="layui-btn primary-btn"
                        lay-submit
                        lay-filter="submit"
                    >
                        保存
                    </button>
                    <button
                        class="layui-btn layui-btn-primary cancel-btn"
                        id="examine-addknow-back"
                    >
                        返回
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
    layui.use(['form'], function() {
        var form = layui.form,
            $ = layui.jquery,
            admin = layui.admin,
            route = layui.router(),
            id = route.search.id

        form.render()

        form.on('submit(submit)', function(data) {
            userInfo = data.field
            userInfo.curriculumId = Number($('#curriculumId').val())
            addData(userInfo)

            $('#login-user').addClass('show')
            return false
        })

        $('#examine-addknow-back').on('click', function() {
            location.href = 'index.html#/examine/knowledge'
        })

        getCourseList(function() {
            if (id) {
                getDetails()
            }
        })
        getKnowList(function() {
            if (id) {
                getDetails()
            }
        })

        function getDetails() {
            admin.get({
                url: '/knowledgePoint/queryById?id=' + id,
                success: function(res) {
                    $('#name').val(res.data.pName)
                    $('#pName').val(res.data.pId)
                    $('#curriculumId').val(res.data.curriculumId)
                    $('#describe').val(res.data.describe)
                }
            })
        }

        function addData(data) {
            var formData = {
                parentId: $('#pName').val(),
                name: data.name,
                curriculumId: data.curriculumId,
                describe: data.describe
            }

            admin.post({
                url: '/knowledgePoint/add',
                data: JSON.stringify(formData),
                success: function() {
                    layer.msg('添加成功！')
                    window.history.back(-1)
                }
            })
        }

        function getCourseList(callback) {
            var data = {
                page: 1,
                rows: 1000000
            }
            admin.post({
                url: '/vsMpCurriculum/getList',
                data: JSON.stringify(data),
                success: function(res) {
                    res.data &&
                        res.data.items &&
                        res.data.items.forEach(item => {
                            $('#curriculumId').append(
                                '<option value="' +
                                    item.id +
                                    '">' +
                                    item.curriculumName +
                                    '</option>'
                            )
                        })
                    form.render()
                    callback && typeof callback === 'function' && callback()
                },
                error: function(err) {
                    layer.msg((err && err.msg) || '数据请求失败')
                }
            })
        }

        function getKnowList(callback) {
            var data = {
                page: 1,
                rows: 100000
            }
            admin.post({
                url: '/knowledgePoint/queryChildrenByPid?pId=0',
                data: JSON.stringify(data),
                success: function(res) {
                    res.data &&
                        res.data.items &&
                        res.data.items.forEach(item => {
                            $('#pName').append(
                                '<option value="' +
                                    item.id +
                                    '">' +
                                    item.curriculumName +
                                    '</option>'
                            )
                        })
                    form.render()
                    callback && typeof callback === 'function' && callback()
                },
                error: function(err) {
                    layer.msg((err && err.msg) || '数据请求失败')
                }
            })
        }
    })
</script>

<style>
    #examine-addknow {
    }

    .my-add-form {
        padding: 25px 0;
    }
</style>
