<div id="virtualTest-details">
    <div class="course-title">
        <div class="course-title-location">
            <span>您的位置：</span>
            <span
                >选课 > 铁路信号知识 > 虚拟实验 > 虚拟实验列表 >
                虚拟实验信息</span
            >
        </div>
    </div>
    <div class="source-details-inner">
        <div class="layui-row">
            <div class="layui-col-md4 layui-form-item">
                <label class="layui-form-label ">实验名称</label>
                <span id="curriculumExperimentName"></span>
            </div>
            <div class="layui-col-md4 layui-form-item">
                <label class="layui-form-label ">实验类型</label>
                <span id="experimentType"></span>
            </div>
            <div class="layui-col-md4 layui-form-item">
                <label class="layui-form-label ">所属课程名称</label>
                <span id="courseName"></span>
            </div>
        </div>

        <div class="layui-row" id="noadd">
            <div class="layui-col-md6 layui-form-item">
                <label class="layui-form-label ">实验成绩</label>
                <span id="experimentRatio"></span>
            </div>
            <div class="layui-col-md6 layui-form-item">
                <label class="layui-form-label ">报告成绩</label>
                <span id="reportRatio"></span>
            </div>
        </div>

        <div class="layui-row">
            <div class="layui-col-md12 layui-form-item">
                <label class="layui-form-label">实验要求</label>
                <div class="layui-col-md9">
                    <textarea
                        name="desc"
                        class="layui-textarea"
                        id="require"
                    ></textarea>
                </div>
            </div>
        </div>
        <div class="source-display" id="fileUrl">
            <div id="mune_area">
                <div class="tab_a" id="tab_b">
                    <ul class="tab1 tab1ys">
                        <li>
                            <a
                                    id="tab_ch1"
                                    class="active"
                                    href="javascript:void(0)"
                            ><img src="src/images/xue.png"
                            /></a>
                        </li>
                        <!-- <li>
                            <a id="tab_ch2"
                               href="javascript:void(0)"><img src="src/images/lian.png" /></a>
                        </li> -->
                    </ul>
                    <ul class="tab_con tabcon_sy">
                        <li id="tabcon1">
                            <div
                                    class="munebtnlist"
                                    id="tabcon1_menulist"
                            ></div>
                        </li>
                        <li id="tabcon2" class="hidden">
                            <div class="munebtnlist">
                                <div id="tabcon2_menulist"></div>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
            <div id="mune_btn" class="munebtna" data-zt="a"></div>
            <div
                    id="pagecon"
                    style=" min-width: 900px; height: 500px;float: left"
            >
                <iframe
                        frameBorder="0"
                        id="innerTarget"
                        name="innerTarget"
                        scrolling="no"
                        src="iframe2.htm"
                        style="width: 100%; height: 100%"
                ></iframe>
            </div>
        </div>
        <div class="source-display" id="fileUrl"></div>
        <div class="layui-row">
            <div class="layui-col-md12 layui-form-item">
                <label class="layui-form-label">实验内容</label>
                <div class="layui-col-md9">
                    <textarea
                        name="desc"
                        class="layui-textarea"
                        id="testContent"
                    ></textarea>
                </div>
            </div>
        </div>
        <div class="layui-row">
            <div class="layui-col-md12 layui-form-item">
                <label class="layui-form-label">实验报告</label>
                <div class="layui-col-md9">
                    <textarea
                        name="desc"
                        class="layui-textarea"
                        id="labReport"
                    ></textarea>
                </div>
            </div>
        </div>
        <div class="layui-row">
            <div class="layui-col-md12 layui-form-item">
                <label class="layui-form-label">实验累计用时</label>
                <span id="testTotleTime"></span>
            </div>
        </div>
        <div class="layui-row">
            <div class="layui-col-md12 layui-form-item">
                <label class="layui-form-label "></label>
                <div>
                    <button class="layui-btn primary-btn" lay-submit id="save">
                        暂存
                    </button>
                    <button
                        class="layui-btn primary-btn"
                        lay-submit
                        id="submit"
                    >
                        提交
                    </button>
                    <button
                        class="layui-btn layui-btn-primary cancel-btn"
                        id="back"
                    >
                        返回
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="src/plugins/UnityLoader.js"></script>
<script src="src/plugins/UnityProgress.js"></script>
<script src="src/plugins/resource_url.js"></script>
<script src="menutree/menuTree.js"></script>
<script>
    layui.use(['form', 'admin'], function() {
        var $ = layui.jquery,
            admin = layui.admin,
            conf = layui.conf,
            route = layui.router(),
            id = route.search.id,
            curriculumId = route.search.curriculumId,
            type = route.search.type,
            details = {},
            startDate = new Date()
        getDetails()
        $('#save').on('click', function() {
            // todo
            save()
        })
        $('#submit').on('click', function() {
            // todo
            submit()
        })
        $('#back').on('click', function() {
            window.history.go(-1)
        })

        function getDetails() {
            admin.get({
                url:
                    '/vsMpTestRecord/startReLookTest?curriculumExperimentId=' +
                    id,
                success: function(res) {
                    var data = JSON.parse(res.data)
                    details = data
                    $('#curriculumExperimentName').html(
                        data.curriculumExperimentName
                    )
                    $('#experimentType').html(data.experimentType)
                    $('#courseName').html(data.courseName)
                    $('#require').html(data.require)
                    $('#labReport').html(data.labReport)
                    $('#testContent').html(data.testContent)
                    $('#testTotleTime').html(data.testTotleTime)
                    /*$('#fileUrl').html(
                        '<img src="' +
                            data.resourceIds +
                            '" style="width: 100%; height: 100%;">'
                    )*/
                    debugger
                    if (res.data.dataType === 2) {
                        var list = JSON.parse(res.data.resourceIds),
                            str = ''
                        for(var i = 0; i < list.length; i++) {
                            str += '<img src="' + conf.fileRequestUrl + '/' +list[i].url + '">'
                        }
                        $('#fileUrl').html(str)
                        return;
                    }
                    fileUrl = conf.fileRequestUrl + '/' + JSON.parse(res.data.resourceIds)[0].url
                    if (res.data.dataType == 1) {
                        // 文档
                        // window.open(fileUrl)
                        $('#fileUrl').hide()
                    } else if (res.data.dataType == 2) {
                        // 图片
                        $('#fileUrl').html(
                            '<img src="' +
                            fileUrl +
                            '" style="width: 100%; height: 100%;">'
                        )
                    } else if (res.data.dataType == 3) {
                        // 视频
                        $('#fileUrl').html(
                            '<video src="' +
                            fileUrl +
                            '" controls="controls" style="width: 100%; height: 100%;">'
                        )
                    } else if (res.data.dataType == 4) {
                        $('#fileUrl').html(
                            '<embed src="' +
                            fileUrl +
                            '" type="application/x-shockwave-flash" style="width: 100%; height: 100%;" quality="high" />'
                        )
                    } else if (res.data.dataType == 5) {
                        // exe
                        $('#fileUrl').hide()
                    } else if (res.data.dataType == 6) {
                        // U3D
                        $('#fileUrl').html('')
//                        var jsonFile = JSON.parse(res.data.fileUrl).json
                        UnityLoader.instantiate(
                            'fileUrl',
                            fileUrl,
                            {
                                onProgress: UnityProgress
                            }
                        )
                    } else if (res.data.dataType == 7) {
                        debugger
                        console.log(111222, res.data.resourceIds)
                        console.log(33333, JSON.parse(res.data.resourceIds))
                        // scorm课件
                        var sourceList = JSON.parse(res.data.resourceIds)[0].url
                        var munebtn = document.getElementById('mune_btn')
                        var mune = document.getElementById('mune_area')
                        var treeStr = ''

                        for (var i = 0; i < sourceList.length; i++) {
                            var floor = ''
                            for (
                                var k = 0;
                                k < Number(sourceList[i].floor);
                                k++
                            ) {
                                floor += '-'
                            }
                            addtree(
                                floor + sourceList[i].name,
                                'http://39.104.97.6:8001/' +
                                sourceList[i].sourceName,
                                'innerTarget'
                            )
                        }
                        createtree('tabcon1_menulist')

                        $('.menu-list').click(function() {
                            getSWFUrl(
                                'pagecon',
                                'http://39.104.97.6:8001/' +
                                sourceList[0].sourceName
                            )
                        })
                        munebtn.onclick = function() {
                            var p = $('#pagecon')
                            if (this.getAttribute('data-zt') == 'a') {
                                mune.style.display = 'none'
                                this.className = 'munebtnb'
                                this.setAttribute('data-zt', 'b')
                                p.css({ 'min-width': '1126px' })
                            } else {
                                mune.style.display = 'block'
                                this.className = 'munebtna'
                                this.setAttribute('data-zt', 'a')
                                p.css({ 'min-width': '900px' })
                            }
                        }
                    }

                    if (type == 'check' || type == 'review') {
                        $('#experimentRatio').html(data.experimentRatio)
                        $('#reportRatio').html(data.reportRatio)

                        // $('#save').attr('style', 'display:none;')
                        $('#submit').attr('style', 'display:none;')
                        $('#require').attr('disabled', 'true;')
                        $('#labReport').attr('disabled', 'true;')
                        $('#testContent').attr('disabled', 'true;')
                    } else {
                        $('#noadd').attr('style', 'display:none;')
                    }
                }
            })
        }

        function save() {
            debugger
            var endDate = new Date();
            var labReportAddress= details.labReportAddress;
            var testContent= $('#testContent').val();
            var curriculumExperimentId= id;
            var curriculumId= route.search.curriculumId;
            var experimentId= id;
            var totalTime= endDate - startDate;
            var labReport= $('#labReport').val();
            //todo
            var data = {
//                labReportAddress: labReportAddress,
                testContent: testContent,
                curriculumExperimentId: curriculumExperimentId,
                curriculumId: curriculumId,
                experimentId: experimentId,
                totalTime: totalTime,
                labReport: labReport,
                endTime: endDate,
                startTime: startDate
            }
            admin.post({
                url: '/testStaging/add',
                data: JSON.stringify(data),
                success: function(res) {
                    if (res.code === 200) {
                        layer.msg('暂存成功！')
                        window.history.back(-1)
                    } else {
                        layer.msg((res && res.msg) || '添加失败')
                    }
                },
                error: function (err) {
                    layer.msg(err && err.msg || '数据请求失败');
                }
            })
        }

        function submit() {
            //todo
            admin.post({
                url: '/vsMpTestRecord/addMpObject',
                data: JSON.stringify(formData),
                success: function(res) {
                    layer.msg('提交成功')
                    window.history.back(-1)
                }
            })
        }
    })
</script>
<style>
    #virtualTest-details {
    }

    .source-details-inner {
        padding: 20px 0;
    }

    .source-display {
        width: 100%;
        height: 415px;
        background: rgba(0, 0, 0, 0.2);
    }

    #virtualTest-details .layui-form-item span {
        display: inline-block;
        padding: 9px 0px;
        font-size: 16px;
    }

    .layui-textarea {
        width: 100%;
    }
</style>
